# Databricks notebook source


# COMMAND ----------

# MAGIC %sql
# MAGIC --CREATE DATABASE BI;
# MAGIC 
# MAGIC DROP TABLE IF EXISTS BI.validation;
# MAGIC create or replace table BI.validation
# MAGIC using delta
# MAGIC location '/mnt/standard/BI/validation'
# MAGIC as
# MAGIC SELECT
# MAGIC  CAST(FACT_VALIDATION.VALIDATIONDATE as date) as date,
# MAGIC  FACT_VALIDATION.VALIDATIONDATEID AS validationdateid,
# MAGIC case when ( case when FACT_VALIDATION.PRODUCTID is null and FACT_VALIDATION.VALIDATIONSTATUSID=2 then 1 else 0 end )=1 then 'EXTERNE' else rtrim(PRODUCT.CODE) end as code_produit,
# MAGIC table_produit.Nom_produits_voyages_comptable as libelle_produit,
# MAGIC  CASE WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='A' then '59'
# MAGIC   WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='B' then '60'
# MAGIC  WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='C' then '61'
# MAGIC   WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='D' then '62'
# MAGIC  else 
# MAGIC   CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END
# MAGIC   end as code_ligne,
# MAGIC     CASE WHEN FACT_VALIDATION.LINEID=9998 THEN 'DELOCALIZED' ELSE COALESCE(LINE.DESCRIPTION,'LIGNE INCONNU') END as description_ligne,
# MAGIC     case when (VEHICLETYPE.DESCRIPTION='TRAMWAY') then 2 --'Tramway' 
# MAGIC       WHEN (VEHICLETYPE.DESCRIPTION='URBANBUS') then 1 --'Bus'
# MAGIC       WHEN (VEHICLETYPE.DESCRIPTION='NAVETTE FLUVIALE') then 3 --'Bus'
# MAGIC       else VEHICLETYPE.ID end
# MAGIC       as code_mode,
# MAGIC   count(FACT_VALIDATION.VALIDATIONID) as nbre_validation
# MAGIC FROM
# MAGIC   FACT_VALIDATION 
# MAGIC    LEFT OUTER JOIN DIM_PRODUCT ON (FACT_VALIDATION.FAREPRODUCTITEMID=DIM_PRODUCT.FAREPRODUCTITEMID)
# MAGIC    LEFT OUTER JOIN PRODUCT ON (FACT_VALIDATION.PRODUCTID=PRODUCT.PRODUCTID)
# MAGIC    LEFT OUTER JOIN LINE ON (FACT_VALIDATION.LINEID=LINE.LINEID)
# MAGIC    LEFT OUTER JOIN DEVICE ON (FACT_VALIDATION.DEVICEID=DEVICE.DEVICEID)
# MAGIC    LEFT OUTER JOIN DEVICETYPE ON (DEVICE.DEVICETYPEID=DEVICETYPE.DEVICETYPEID)
# MAGIC    LEFT OUTER JOIN VALIDATIONSTATUS ON (FACT_VALIDATION.VALIDATIONSTATUSID=VALIDATIONSTATUS.VALIDATIONSTATUSID)
# MAGIC    LEFT OUTER JOIN VEHICLE ON (FACT_VALIDATION.VEHICLEID=VEHICLE.VEHICLEID)
# MAGIC    LEFT OUTER JOIN VEHICLETYPE ON (VEHICLETYPE.ID=VEHICLE.VEHICLETYPEID)
# MAGIC    LEFT OUTER JOIN table_produit ON (table_produit.Code_produit = PRODUCT.CODE)
# MAGIC 
# MAGIC WHERE
# MAGIC DEVICETYPE.DESCRIPTION  IN  ( 'MOBILE TICKETING','VAL'  )
# MAGIC and
# MAGIC VALIDATIONSTATUS.CODE='OK'
# MAGIC 
# MAGIC --cast(FACT_VALIDATION.VALIDATIONDATE as date)>='2022-02-01'
# MAGIC GROUP BY
# MAGIC  CAST(FACT_VALIDATION.VALIDATIONDATE as date),
# MAGIC  FACT_VALIDATION.VALIDATIONDATEID,
# MAGIC  case when ( case when FACT_VALIDATION.PRODUCTID is null and FACT_VALIDATION.VALIDATIONSTATUSID=2 then 1 else 0 end )=1 then 'EXTERNE' else rtrim(PRODUCT.CODE) end ,
# MAGIC  table_produit.Nom_produits_voyages_comptable,
# MAGIC  CASE WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='A' then '59'
# MAGIC   WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='B' then '60'
# MAGIC    WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='C' then '61'
# MAGIC    WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='D' then '62'
# MAGIC   else 
# MAGIC  CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END
# MAGIC   end,
# MAGIC    CASE WHEN FACT_VALIDATION.LINEID=9998 THEN 'DELOCALIZED' ELSE COALESCE(LINE.DESCRIPTION,'LIGNE INCONNU') END ,
# MAGIC     case when (VEHICLETYPE.DESCRIPTION='TRAMWAY') then 2 --'Tramway' 
# MAGIC       WHEN (VEHICLETYPE.DESCRIPTION='URBANBUS') then 1 --'Bus'
# MAGIC       WHEN (VEHICLETYPE.DESCRIPTION='NAVETTE FLUVIALE') then 3 --'Bus'
# MAGIC       else VEHICLETYPE.ID end

# COMMAND ----------

# MAGIC %sql
# MAGIC --CREATE DATABASE BI;
# MAGIC 
# MAGIC DROP TABLE IF EXISTS BI.validationgeo;
# MAGIC create or replace table BI.validationgeo
# MAGIC using delta
# MAGIC location '/mnt/standard/BI/validationgeo'
# MAGIC as
# MAGIC SELECT
# MAGIC  CAST(FACT_VALIDATION.VALIDATIONDATE as date) as date,
# MAGIC  FACT_VALIDATION.VALIDATIONDATEID AS validationdateid,
# MAGIC case when ( case when FACT_VALIDATION.PRODUCTID is null and FACT_VALIDATION.VALIDATIONSTATUSID=2 then 1 else 0 end )=1 then 'EXTERNE' else rtrim(PRODUCT.CODE) end as code_produit,
# MAGIC table_produit.Nom_produits_voyages_comptable as libelle_produit,
# MAGIC  CASE WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='A' then '59'
# MAGIC   WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='B' then '60'
# MAGIC  WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='C' then '61'
# MAGIC   WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='D' then '62'
# MAGIC  else 
# MAGIC   CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END
# MAGIC   end as code_ligne,
# MAGIC     CASE WHEN FACT_VALIDATION.LINEID=9998 THEN 'DELOCALIZED' ELSE COALESCE(LINE.DESCRIPTION,'LIGNE INCONNU') END as description_ligne,
# MAGIC     case when (VEHICLETYPE.DESCRIPTION='TRAMWAY') then 2 --'Tramway' 
# MAGIC       WHEN (VEHICLETYPE.DESCRIPTION='URBANBUS') then 1 --'Bus'
# MAGIC       WHEN (VEHICLETYPE.DESCRIPTION='NAVETTE FLUVIALE') then 3 --'Bus'
# MAGIC       else VEHICLETYPE.ID end
# MAGIC       as code_mode,
# MAGIC   arret_evw.NOMSAE,
# MAGIC   arret_evw.shape,
# MAGIC   count(FACT_VALIDATION.VALIDATIONID) as nbre_validation
# MAGIC FROM
# MAGIC   billettique.FACT_VALIDATION 
# MAGIC    LEFT OUTER JOIN billettique.DIM_PRODUCT ON (FACT_VALIDATION.FAREPRODUCTITEMID=DIM_PRODUCT.FAREPRODUCTITEMID)
# MAGIC    LEFT OUTER JOIN billettique.PRODUCT ON (FACT_VALIDATION.PRODUCTID=PRODUCT.PRODUCTID)
# MAGIC    LEFT OUTER JOIN billettique.LINE ON (FACT_VALIDATION.LINEID=LINE.LINEID)
# MAGIC    LEFT OUTER JOIN billettique.DEVICE ON (FACT_VALIDATION.DEVICEID=DEVICE.DEVICEID)
# MAGIC    LEFT OUTER JOIN billettique.DEVICETYPE ON (DEVICE.DEVICETYPEID=DEVICETYPE.DEVICETYPEID)
# MAGIC    LEFT OUTER JOIN billettique.VALIDATIONSTATUS ON (FACT_VALIDATION.VALIDATIONSTATUSID=VALIDATIONSTATUS.VALIDATIONSTATUSID)
# MAGIC    LEFT OUTER JOIN billettique.VEHICLE ON (FACT_VALIDATION.VEHICLEID=VEHICLE.VEHICLEID)
# MAGIC    LEFT OUTER JOIN billettique.VEHICLETYPE ON (VEHICLETYPE.ID=VEHICLE.VEHICLETYPEID)
# MAGIC    LEFT OUTER JOIN ref_produit.table_produit ON (table_produit.Code_produit = PRODUCT.CODE)
# MAGIC    left outer join billettique.stop on (stop.STOPID = FACT_VALIDATION.FARESTOPID)
# MAGIC    left outer join sig.arret_evw on (arret_evw.IDARRET = stop.num)
# MAGIC 
# MAGIC WHERE
# MAGIC DEVICETYPE.DESCRIPTION  IN  ( 'MOBILE TICKETING','VAL'  )
# MAGIC and
# MAGIC VALIDATIONSTATUS.CODE='OK'
# MAGIC 
# MAGIC --cast(FACT_VALIDATION.VALIDATIONDATE as date)>='2022-02-01'
# MAGIC GROUP BY
# MAGIC  CAST(FACT_VALIDATION.VALIDATIONDATE as date),
# MAGIC  FACT_VALIDATION.VALIDATIONDATEID,
# MAGIC  case when ( case when FACT_VALIDATION.PRODUCTID is null and FACT_VALIDATION.VALIDATIONSTATUSID=2 then 1 else 0 end )=1 then 'EXTERNE' else rtrim(PRODUCT.CODE) end ,
# MAGIC  table_produit.Nom_produits_voyages_comptable,
# MAGIC  CASE WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='A' then '59'
# MAGIC   WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='B' then '60'
# MAGIC    WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='C' then '61'
# MAGIC    WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='D' then '62'
# MAGIC   else 
# MAGIC  CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END
# MAGIC   end,
# MAGIC    CASE WHEN FACT_VALIDATION.LINEID=9998 THEN 'DELOCALIZED' ELSE COALESCE(LINE.DESCRIPTION,'LIGNE INCONNU') END ,
# MAGIC     case when (VEHICLETYPE.DESCRIPTION='TRAMWAY') then 2 --'Tramway' 
# MAGIC       WHEN (VEHICLETYPE.DESCRIPTION='URBANBUS') then 1 --'Bus'
# MAGIC       WHEN (VEHICLETYPE.DESCRIPTION='NAVETTE FLUVIALE') then 3 --'Bus'
# MAGIC       else VEHICLETYPE.ID end,
# MAGIC   arret_evw.NOMSAE,
# MAGIC   arret_evw.shape

# COMMAND ----------

# MAGIC %sql
# MAGIC 
# MAGIC select * 
# MAGIC from billettique.stop
# MAGIC where num = 2812

# COMMAND ----------

# MAGIC %sql
# MAGIC --st_geomFromWKB
# MAGIC 
# MAGIC select arret_evw.NOMSAE,
# MAGIC   st_geomFromWKB(arret_evw.shape)
# MAGIC from sig.arret_evw 

# COMMAND ----------

# MAGIC %pip install matplotlib
