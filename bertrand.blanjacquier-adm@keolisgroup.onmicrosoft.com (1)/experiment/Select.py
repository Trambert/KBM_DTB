# Databricks notebook source
# MAGIC %sql
# MAGIC 
# MAGIC SELECT
# MAGIC  CAST(FACT_VALIDATION.VALIDATIONDATE as date) as date,
# MAGIC --  date_part('DAY',FACT_VALIDATION.VALIDATIONDATE) as day,
# MAGIC --  date_part('MONTH',FACT_VALIDATION.VALIDATIONDATE) as month,
# MAGIC --   date_part('YEAR',FACT_VALIDATION.VALIDATIONDATE) as year,
# MAGIC -- case when ( case when FACT_VALIDATION.PRODUCTID is null and FACT_VALIDATION.VALIDATIONSTATUSID=2 then 1 else 0 end )=1 then 'EXTERNE' else rtrim(PRODUCT.CODE) end as code_produit,
# MAGIC --  CASE WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='A' then '59'
# MAGIC --   WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='B' then '60'
# MAGIC --  WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='C' then '61'
# MAGIC --   WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='D' then '62'
# MAGIC --  else 
# MAGIC --   CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END
# MAGIC --   end as code_ligne,
# MAGIC   count(FACT_VALIDATION.VALIDATIONID) as nbre_validation
# MAGIC FROM
# MAGIC   FACT_VALIDATION 
# MAGIC    LEFT OUTER JOIN DIM_PRODUCT ON (FACT_VALIDATION.FAREPRODUCTITEMID=DIM_PRODUCT.FAREPRODUCTITEMID)
# MAGIC  LEFT OUTER JOIN PRODUCT ON (FACT_VALIDATION.PRODUCTID=PRODUCT.PRODUCTID)
# MAGIC   LEFT OUTER JOIN LINE ON (FACT_VALIDATION.LINEID=LINE.LINEID)
# MAGIC    LEFT OUTER JOIN DEVICE ON (FACT_VALIDATION.DEVICEID=DEVICE.DEVICEID)
# MAGIC LEFT OUTER JOIN DEVICETYPE ON (DEVICE.DEVICETYPEID=DEVICETYPE.DEVICETYPEID)
# MAGIC WHERE
# MAGIC DEVICETYPE.DESCRIPTION  IN  ( 'MOBILE TICKETING','VAL'  )
# MAGIC and
# MAGIC FACT_VALIDATION.VALIDATIONSTATUSID=1
# MAGIC and
# MAGIC cast(FACT_VALIDATION.VALIDATIONDATE as date)>='2022-01-01'
# MAGIC GROUP BY
# MAGIC  CAST(FACT_VALIDATION.VALIDATIONDATE as date)
# MAGIC --  date_part('DAY',FACT_VALIDATION.VALIDATIONDATE) ,
# MAGIC --  date_part('MONTH',FACT_VALIDATION.VALIDATIONDATE) ,
# MAGIC --  date_part('YEAR',FACT_VALIDATION.VALIDATIONDATE) --,
# MAGIC --  case when ( case when FACT_VALIDATION.PRODUCTID is null and FACT_VALIDATION.VALIDATIONSTATUSID=2 then 1 else 0 end )=1 then 'EXTERNE' else rtrim(PRODUCT.CODE) end ,
# MAGIC --  CASE WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='A' then '59'
# MAGIC --   WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='B' then '60'
# MAGIC --    WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='C' then '61'
# MAGIC --    WHEN (CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END)='D' then '62'
# MAGIC --   else 
# MAGIC --  CASE WHEN FACT_VALIDATION.LINEID=9998 THEN '9998' ELSE LINE.CODE END
# MAGIC --   end 
# MAGIC --LIMIT 10
# MAGIC order by CAST(FACT_VALIDATION.VALIDATIONDATE as date) desc

# COMMAND ----------

# MAGIC %sql
# MAGIC 
# MAGIC select count(*), CAST(validationdate as date)
# MAGIC from FACT_VALIDATION
# MAGIC LEFT OUTER JOIN DEVICE ON (FACT_VALIDATION.DEVICEID=DEVICE.DEVICEID)
# MAGIC LEFT OUTER JOIN DEVICETYPE ON (DEVICE.DEVICETYPEID=DEVICETYPE.DEVICETYPEID)
# MAGIC where validationdate >= '2022-01-01'
# MAGIC and DEVICETYPE.DESCRIPTION  IN  ( 'MOBILE TICKETING','VAL'  )
# MAGIC and
# MAGIC FACT_VALIDATION.VALIDATIONSTATUSID=1
# MAGIC group by CAST(validationdate as date)
# MAGIC order by CAST(validationdate as date)
